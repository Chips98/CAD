sequenceDiagram
    participant 用户
    participant 主程序
    participant AI工厂
    participant 模拟引擎
    participant 配置系统
    participant 事件生成器
    participant 模板分析器
    participant 学生智能体
    participant 家庭智能体
    participant 学校智能体
    participant AI客户端
    participant 数据存储
    participant 咨询管理器
    participant 心理咨询师
    
    Note over 用户,心理咨询师: 🚀 系统启动阶段
    用户->>主程序: 启动程序
    主程序->>主程序: 显示欢迎信息
    主程序->>主程序: 加载配置
    主程序->>AI工厂: 获取可用提供商
    AI工厂-->>主程序: ["gemini", "deepseek"]
    主程序->>主程序: 选择AI提供商
    主程序->>AI工厂: 获取客户端实例
    AI工厂-->>主程序: AI客户端
    
    Note over 用户,心理咨询师: 🎭 模拟设置阶段
    用户->>主程序: 选择"运行心理健康模拟"
    主程序->>模拟引擎: 创建模拟引擎
    模拟引擎->>配置系统: 导入配置模块
    配置系统-->>模拟引擎: 角色和事件配置
    
    模拟引擎->>模拟引擎: 设置模拟环境
    模拟引擎->>学生智能体: 创建学生智能体(李明)
    学生智能体-->>模拟引擎: 学生实例
    模拟引擎->>家庭智能体: 创建家庭智能体(父母)
    家庭智能体-->>模拟引擎: 家庭实例
    模拟引擎->>学校智能体: 创建学校智能体(老师/同学)
    学校智能体-->>模拟引擎: 学校实例
    
    模拟引擎->>事件生成器: 初始化事件生成器
    事件生成器->>模板分析器: 分析事件模板
    模板分析器-->>事件生成器: 模板模式
    
    Note over 用户,心理咨询师: 📅 30天模拟执行
    模拟引擎->>模拟引擎: 开始30天循环
    
    loop 每天模拟
        模拟引擎->>模拟引擎: 确定当前发展阶段
        模拟引擎->>事件生成器: 生成当日事件
        
        loop 每日事件处理
            事件生成器->>模板分析器: 选择事件模板
            模板分析器-->>事件生成器: 最佳模板
            事件生成器->>AI客户端: 生成事件描述
            AI客户端-->>事件生成器: 事件内容
            事件生成器-->>模拟引擎: 验证后的事件
            
            模拟引擎->>学生智能体: 处理事件影响
            学生智能体->>学生智能体: 更新心理状态
            学生智能体->>AI客户端: 生成回应
            AI客户端-->>学生智能体: 智能体回应
            学生智能体-->>模拟引擎: 处理结果
            
            模拟引擎->>家庭智能体: 家庭成员反应
            家庭智能体->>AI客户端: 生成家庭回应
            AI客户端-->>家庭智能体: 家庭反应
            家庭智能体-->>模拟引擎: 家庭处理结果
            
            模拟引擎->>学校智能体: 学校相关反应
            学校智能体->>AI客户端: 生成学校回应
            AI客户端-->>学校智能体: 学校反应
            学校智能体-->>模拟引擎: 学校处理结果
        end
        
        模拟引擎->>数据存储: 保存当日状态
        数据存储-->>模拟引擎: 保存完成
    end
    
    模拟引擎->>AI客户端: 生成最终分析报告
    AI客户端-->>模拟引擎: AI分析内容
    模拟引擎->>数据存储: 保存最终报告
    模拟引擎-->>主程序: 模拟完成
    主程序-->>用户: 显示结果摘要
    
    Note over 用户,心理咨询师: 💬 心理咨询阶段
    用户->>主程序: 选择"心理咨询对话"
    主程序->>咨询管理器: 创建咨询管理器
    咨询管理器->>数据存储: 加载患者最终状态
    数据存储-->>咨询管理器: 患者数据
    咨询管理器-->>用户: 显示患者状态面板
    
    咨询管理器->>咨询管理器: 初始化恢复追踪
    
    loop 咨询对话循环
        用户->>咨询管理器: 输入咨询内容
        咨询管理器->>咨询管理器: 生成患者回应提示
        咨询管理器->>AI客户端: 请求患者回应
        AI客户端-->>咨询管理器: 患者回应内容
        
        咨询管理器->>咨询管理器: 评估对话效果
        咨询管理器->>AI客户端: 评估治疗效果
        AI客户端-->>咨询管理器: 效果评分和分析
        
        alt 触发AI督导
            咨询管理器->>心理咨询师: 请求专业督导
            心理咨询师->>AI客户端: 生成督导建议
            AI客户端-->>心理咨询师: 督导内容
            心理咨询师-->>咨询管理器: 督导建议
            咨询管理器-->>用户: 显示督导建议
        end
        
        咨询管理器->>咨询管理器: 更新抑郁程度
        
        alt 治疗改善
            咨询管理器-->>用户: "🎉 治疗取得突破性进展!"
        else 状态恶化
            咨询管理器-->>用户: "⚠️ 警告：患者状态恶化"
        end
        
        alt 查看进展
            用户->>咨询管理器: 输入"进展"查看
            咨询管理器-->>用户: 显示详细治疗进展
        else 结束咨询
            用户->>咨询管理器: 输入"退出"
            咨询管理器->>数据存储: 保存咨询记录
            咨询管理器-->>用户: "咨询会话已保存"
        end
        
        咨询管理器-->>用户: 显示患者回应和评估
    end
    
    Note over 用户,心理咨询师: 📊 报告查看
    用户->>主程序: 选择"查看模拟报告"
    主程序->>数据存储: 扫描模拟记录
    数据存储-->>主程序: 可用报告列表
    主程序-->>用户: 显示报告列表
    用户->>主程序: 选择特定报告
    主程序->>数据存储: 读取报告内容
    数据存储-->>主程序: 报告详情
    主程序-->>用户: 显示详细报告