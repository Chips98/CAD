{% extends "base.html" %}

{% block title %}å¿ƒç†æ²»ç–—å¯¹è¯{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- å·¦ä¾§æ‚£è€…é€‰æ‹©é¢æ¿ -->
        <div class="col-md-4 col-lg-3 bg-light border-right therapy-sidebar" style="height: 100vh; overflow-y: auto;">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">æ‚£è€…é€‰æ‹©</h5>
                    <button id="refresh-patients" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
                
                <!-- AIæä¾›å•†é€‰æ‹© -->
                <div class="mb-3">
                    <label for="ai-provider-select" class="form-label">AIæä¾›å•†</label>
                    <select id="ai-provider-select" class="form-select">
                        <option value="deepseek">DeepSeek</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                
                <!-- æ‚£è€…åˆ—è¡¨ -->
                <div id="patient-list" class="mb-3">
                    <div class="text-center text-muted">æ­£åœ¨åŠ è½½æ‚£è€…æ•°æ®...</div>
                </div>
                
                <!-- æ–‡ä»¶é€‰æ‹© -->
                <div id="file-selection" style="display: none;">
                    <h6 class="border-top pt-3">é€‰æ‹©æ•°æ®æº</h6>
                    <div id="file-list"></div>
                </div>
                
                <!-- æ²»ç–—å¯åŠ¨æŒ‰é’® -->
                <div class="border-top pt-3">
                    <button id="start-human-therapy" class="btn btn-primary w-100 mb-2" disabled>
                        <i class="fas fa-user-md"></i> å¼€å§‹äººå·¥æ²»ç–—
                    </button>
                    <button id="start-ai-therapy" class="btn btn-success w-100" disabled>
                        <i class="fas fa-robot"></i> å¼€å§‹AIå¯¹AIæ²»ç–—
                    </button>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§å¯¹è¯åŒºåŸŸ -->
        <div class="col-md-8 col-lg-9 d-flex flex-column">
            <!-- å¯¹è¯å¤´éƒ¨ -->
            <div class="bg-white border-bottom p-3">
                <h4 class="mb-1">å¿ƒç†æ²»ç–—å¯¹è¯</h4>
                <small class="text-muted">é€‰æ‹©æ‚£è€…åå¼€å§‹æ²»ç–—ä¼šè¯</small>
            </div>
            
            <!-- èŠå¤©å®¹å™¨ -->
            <div class="chat-container flex-grow-1 d-flex flex-column" style="display: none;">
                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto; min-height: 400px;">
                    <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <!-- äººå·¥æ²»ç–—è¾“å…¥åŒºåŸŸ -->
                <div class="human-input border-top p-3" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="user-message" class="form-control" 
                               placeholder="è¾“å…¥æ‚¨çš„æ²»ç–—å»ºè®®...">
                        <button id="send-message" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- æ²»ç–—è¿›å±•é¢æ¿ -->
            <div id="therapy-progress" class="bg-light border-top p-3" style="display: none;">
                <h6>æ²»ç–—è¿›å±•</h6>
                <div class="row">
                    <div class="col-md-3">
                        <small class="text-muted">å½“å‰è½®æ•°</small>
                        <div id="current-round">0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">æ²»ç–—æ•ˆæœ</small>
                        <div id="therapy-score">0.0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">æ²»ç–—è”ç›Ÿ</small>
                        <div id="alliance-score">0.0</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">é£é™©ç­‰çº§</small>
                        <div id="risk-level">ä½</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.patient-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.patient-card:hover {
    border-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.15);
}

.patient-card.selected {
    border-color: #007bff;
    background-color: #e7f1ff;
}

.patient-card h4 {
    font-size: 16px;
    margin-bottom: 8px;
    color: #333;
}

.patient-card .sim-id {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.patient-card .status {
    font-size: 13px;
    color: #28a745;
    margin-bottom: 4px;
}

.patient-card .depression-level {
    font-size: 13px;
    color: #dc3545;
    margin-bottom: 4px;
}

.patient-card .therapy-count {
    font-size: 12px;
    color: #17a2b8;
    margin-bottom: 0;
}

.file-item {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-item:hover {
    border-color: #28a745;
    background-color: #f8f9fa;
}

.file-item.selected {
    border-color: #28a745;
    background-color: #d4edda;
}

.file-item.recommended {
    border-color: #ffc107;
    background-color: #fff3cd;
}

.file-item h5 {
    font-size: 14px;
    margin-bottom: 4px;
    color: #333;
}

.file-item .file-desc {
    font-size: 12px;
    color: #666;
    margin-bottom: 0;
}

.message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 80%;
    word-wrap: break-word;
}

.therapist-message {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    margin-right: 0;
}

.patient-message {
    background-color: #f8f9fa;
    color: #333;
    border: 1px solid #e9ecef;
    margin-left: 0;
    margin-right: auto;
}

.system-message {
    background-color: #6c757d;
    color: white;
    margin: 0 auto;
    text-align: center;
    font-size: 14px;
}

.message-header {
    font-weight: bold;
    font-size: 12px;
    margin-bottom: 5px;
    opacity: 0.8;
}

.message-content {
    margin-bottom: 5px;
    line-height: 1.4;
}

.message-time {
    font-size: 11px;
    opacity: 0.6;
    text-align: right;
}

.no-data {
    text-align: center;
    color: #6c757d;
    padding: 20px;
    font-style: italic;
}
</style>

<script>
let selectedPatient = null;
let selectedFile = null;
let therapySession = null;
let isHumanTherapy = false;

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('refresh-patients').addEventListener('click', loadPatients);
    document.getElementById('start-ai-therapy').addEventListener('click', startAITherapy);
    document.getElementById('start-human-therapy').addEventListener('click', startHumanTherapy);
    document.getElementById('send-message').addEventListener('click', sendMessage);
    
    // å›è½¦å‘é€æ¶ˆæ¯
    document.getElementById('user-message').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // WebSocketäº‹ä»¶ç›‘å¬
    socket.on('therapy_status', function(data) {
        showStatus(data.message);
        if (data.status === 'completed') {
            showStatus('AIå¯¹AIæ²»ç–—å®Œæˆï¼');
            if (data.summary) {
                showStatus('æ²»ç–—æ€»ç»“: ' + JSON.stringify(data.summary, null, 2));
            }
        }
    });
});

// åŠ è½½æ‚£è€…æ•°æ®
function loadPatients() {
    fetch('/api/patient_files')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPatients(data.simulations);
            } else {
                showError('åŠ è½½æ‚£è€…æ•°æ®å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('ç½‘ç»œé”™è¯¯: ' + error.message);
        });
}

// æ˜¾ç¤ºæ‚£è€…åˆ—è¡¨
function displayPatients(simulations) {
    const patientList = document.getElementById('patient-list');
    
    if (simulations.length === 0) {
        patientList.innerHTML = '<div class="no-data">æš‚æ— æ‚£è€…æ•°æ®</div>';
        return;
    }
    
    let html = '';
    simulations.forEach((sim, index) => {
        html += `
            <div class="patient-card" onclick="selectPatient('${sim.sim_id}', ${index})">
                <h4>${sim.patient_name}</h4>
                <p class="sim-id">${sim.sim_id}</p>
                <p class="status">${sim.status}</p>
                <p class="depression-level">æŠ‘éƒç¨‹åº¦: ${getDepressionLevelText(sim.depression_level)}</p>
                ${sim.therapy_sessions > 0 ? `<p class="therapy-count">å·²æœ‰${sim.therapy_sessions}æ¬¡æ²»ç–—è®°å½•</p>` : ''}
            </div>
        `;
    });
    
    patientList.innerHTML = html;
    window.simulationsData = simulations; // å­˜å‚¨æ•°æ®ä¾›åç»­ä½¿ç”¨
}

// é€‰æ‹©æ‚£è€…
function selectPatient(simId, index) {
    selectedPatient = {
        sim_id: simId,
        data: window.simulationsData[index]
    };
    
    // æ›´æ–°UI
    document.querySelectorAll('.patient-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.patient-card').classList.add('selected');
    
    // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©
    displayFileSelection(selectedPatient.data.files);
    
    // æ¸…ç©ºèŠå¤©è®°å½•
    clearChat();
}

// æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©
function displayFileSelection(files) {
    const fileSelection = document.getElementById('file-selection');
    const fileList = document.getElementById('file-list');
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="no-data">è¯¥æ‚£è€…æš‚æ— å¯ç”¨æ•°æ®æ–‡ä»¶</div>';
        fileSelection.style.display = 'block';
        return;
    }
    
    let html = '';
    files.forEach((file, index) => {
        const isRecommended = file.type === 'complete';
        html += `
            <div class="file-item ${isRecommended ? 'recommended' : ''}" onclick="selectFile('${file.path}', '${file.name}', '${file.type}')">
                <h5>${file.name} ${isRecommended ? 'â­ æ¨è' : ''}</h5>
                <p class="file-desc">${file.description}</p>
            </div>
        `;
    });
    
    fileList.innerHTML = html;
    fileSelection.style.display = 'block';
}

// é€‰æ‹©æ–‡ä»¶
function selectFile(filePath, fileName, fileType) {
    selectedFile = {
        path: filePath,
        name: fileName,
        type: fileType
    };
    
    // æ›´æ–°UI
    document.querySelectorAll('.file-item').forEach(item => item.classList.remove('selected'));
    event.target.closest('.file-item').classList.add('selected');
    
    // å¯ç”¨æ²»ç–—æŒ‰é’®
    document.getElementById('start-ai-therapy').disabled = false;
    document.getElementById('start-human-therapy').disabled = false;
}

// å¯åŠ¨AIå¯¹AIæ²»ç–—
function startAITherapy() {
    if (!selectedPatient || !selectedFile) {
        showError('è¯·å…ˆé€‰æ‹©æ‚£è€…å’Œæ•°æ®æ–‡ä»¶');
        return;
    }
    
    const aiProvider = document.getElementById('ai-provider-select').value;
    
    showStatus('æ­£åœ¨å¯åŠ¨AIå¯¹AIæ²»ç–—ä¼šè¯...');
    
    fetch('/api/start_ai_therapy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            patient_file: selectedFile.path,
            ai_provider: aiProvider,
            max_turns: 15
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            therapySession = data.session_id;
            isHumanTherapy = false;
            showStatus('AIå¯¹AIæ²»ç–—ä¼šè¯å·²å¯åŠ¨ï¼Œä¼šè¯ID: ' + data.session_id);
            // ç¦ç”¨é€‰æ‹©ç•Œé¢ï¼Œéšè—äººå·¥æ¶ˆæ¯è¾“å…¥
            disableSelection();
            document.querySelector('.human-input').style.display = 'none';
            document.querySelector('.chat-container').style.display = 'flex';
        } else {
            showError('å¯åŠ¨æ²»ç–—å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    });
}

// å¯åŠ¨äººå·¥æ²»ç–—
function startHumanTherapy() {
    if (!selectedPatient || !selectedFile) {
        showError('è¯·å…ˆé€‰æ‹©æ‚£è€…å’Œæ•°æ®æ–‡ä»¶');
        return;
    }
    
    const aiProvider = document.getElementById('ai-provider-select').value;
    
    showStatus('æ­£åœ¨å¯åŠ¨äººå·¥æ²»ç–—ä¼šè¯...');
    
    fetch('/api/start_human_therapy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            patient_file: selectedFile.path,
            ai_provider: aiProvider
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            therapySession = data.session_id;
            isHumanTherapy = true;
            showStatus('äººå·¥æ²»ç–—ä¼šè¯å·²å¯åŠ¨');
            
            // æ˜¾ç¤ºæ‚£è€…ä¿¡æ¯
            const patientInfo = data.patient_info;
                        showStatus(`æ‚£è€…ä¿¡æ¯: å§“å: ${patientInfo.name || 'æœªçŸ¥'}, å¹´é¾„: ${patientInfo.age || 'æœªçŸ¥'}, æŠ‘éƒç¨‹åº¦: ${getDepressionLevelText(patientInfo.depression_level) || 'æœªçŸ¥'}`);            
            
            // å¯ç”¨äººå·¥æ²»ç–—ç•Œé¢
            disableSelection();
            document.querySelector('.human-input').style.display = 'flex';
            document.querySelector('.chat-container').style.display = 'flex';
        } else {
            showError('å¯åŠ¨æ²»ç–—å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    });
}

// å‘é€äººå·¥æ²»ç–—æ¶ˆæ¯
function sendMessage() {
    if (!isHumanTherapy || !therapySession) {
        showError('è¯·å…ˆå¯åŠ¨äººå·¥æ²»ç–—ä¼šè¯');
        return;
    }
    
    const messageInput = document.getElementById('user-message');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // æ˜¾ç¤ºæ²»ç–—å¸ˆæ¶ˆæ¯
    addMessage('therapist', message);
    messageInput.value = '';
    messageInput.disabled = true;
    
    // å‘é€åˆ°åç«¯å¤„ç†
    showStatus('æ‚£è€…æ­£åœ¨æ€è€ƒå›åº”...');
    
    fetch('/api/human_therapy_message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            session_id: therapySession,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addMessage('patient', data.patient_response);
            // æ˜¾ç¤ºæ²»ç–—è¿›å±•
            if (data.session_progress) {
                updateProgress(data.session_progress);
            }
        } else {
            showError('å‘é€æ¶ˆæ¯å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
    })
    .finally(() => {
        messageInput.disabled = false;
        messageInput.focus();
    });
}

// æ›´æ–°æ²»ç–—è¿›å±•
function updateProgress(progress) {
    document.getElementById('therapy-progress').style.display = 'block';
    document.getElementById('current-round').textContent = progress.round || 0;
    document.getElementById('therapy-score').textContent = (progress.therapy_score || 0).toFixed(1);
    document.getElementById('alliance-score').textContent = (progress.alliance_score || 0).toFixed(1);
    document.getElementById('risk-level').textContent = progress.risk_level || 'ä½';
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
function addMessage(sender, message) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const time = new Date().toLocaleTimeString();
    const senderName = {
        'therapist': 'ğŸ‘©â€âš•ï¸ æ²»ç–—å¸ˆ',
        'patient': 'ğŸ§‘â€ğŸ“ æ‚£è€…',
        'system': 'ğŸ¤– ç³»ç»Ÿ'
    }[sender] || sender;
    
    messageDiv.innerHTML = `
        <div class="message-header">${senderName}</div>
        <div class="message-content">${message}</div>
        <div class="message-time">${time}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// ç¦ç”¨é€‰æ‹©ç•Œé¢
function disableSelection() {
    document.querySelector('.therapy-sidebar').style.opacity = '0.5';
    document.getElementById('start-ai-therapy').disabled = true;
    document.getElementById('start-human-therapy').disabled = true;
}

// æ¸…ç©ºèŠå¤©è®°å½•
function clearChat() {
    document.getElementById('chat-messages').innerHTML = '';
    document.querySelector('.chat-container').style.display = 'none';
    document.querySelector('.human-input').style.display = 'none';
    document.querySelector('.therapy-sidebar').style.opacity = '1';
    document.getElementById('therapy-progress').style.display = 'none';
    therapySession = null;
    isHumanTherapy = false;
    
    // é‡æ–°å¯ç”¨æŒ‰é’®
    if (selectedFile) {
        document.getElementById('start-ai-therapy').disabled = false;
        document.getElementById('start-human-therapy').disabled = false;
    }
}

// æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
function showStatus(message) {
    addMessage('system', message);
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    addMessage('system', 'âŒ ' + message);
}

// è·å–æŠ‘éƒç¨‹åº¦æ–‡æœ¬ï¼ˆæ”¯æŒ10çº§ç²¾ç»†åˆ†çº§ï¼‰
function getDepressionLevelText(level) {
    const depressionLevelMap = {
        // æ•°å­—æ˜ å°„
        0: "æœ€ä½³çŠ¶æ€", 1: "å¥åº·æ­£å¸¸", 2: "æœ€å°ç—‡çŠ¶", 3: "è½»åº¦é£é™©", 4: "è½»åº¦æŠ‘éƒ",
        5: "ä¸­è½»åº¦æŠ‘éƒ", 6: "ä¸­åº¦æŠ‘éƒ", 7: "ä¸­é‡åº¦æŠ‘éƒ", 8: "é‡åº¦æŠ‘éƒ", 9: "æé‡åº¦æŠ‘éƒ",
        // å­—ç¬¦ä¸²æ˜ å°„
        "OPTIMAL": "æœ€ä½³çŠ¶æ€", "HEALTHY": "å¥åº·æ­£å¸¸", "MINIMAL_SYMPTOMS": "æœ€å°ç—‡çŠ¶",
        "MILD_RISK": "è½»åº¦é£é™©", "MILD": "è½»åº¦æŠ‘éƒ", "MODERATE_MILD": "ä¸­è½»åº¦æŠ‘éƒ",
        "MODERATE": "ä¸­åº¦æŠ‘éƒ", "MODERATE_SEVERE": "ä¸­é‡åº¦æŠ‘éƒ", "SEVERE": "é‡åº¦æŠ‘éƒ", "CRITICAL": "æé‡åº¦æŠ‘éƒ"
    };
    
    return depressionLevelMap[level] || level || 'æœªçŸ¥';
}
</script>
{% endblock %} 