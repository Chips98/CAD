{% extends "base.html" %}

{% block title %}å¢å¼ºå¿ƒç†æ²»ç–—å¯¹è¯{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <!-- å·¦ä¾§æ‚£è€…é€‰æ‹©é¢æ¿ -->
        <div class="col-md-3 bg-light border-right therapy-sidebar" style="height: 100vh; overflow-y: auto;">
            <div class="p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">æ‚£è€…é€‰æ‹©</h5>
                    <button id="refresh-patients" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                </div>
                
                <!-- AIæä¾›å•†é€‰æ‹© -->
                <div class="mb-3">
                    <label for="ai-provider-select" class="form-label">AIæä¾›å•†</label>
                    <select id="ai-provider-select" class="form-select">
                        <option value="deepseek">DeepSeek</option>
                        <option value="gemini">Google Gemini</option>
                    </select>
                </div>
                
                <!-- æ‚£è€…åˆ—è¡¨ -->
                <div id="patient-list" class="mb-3">
                    <div class="text-center text-muted">æ­£åœ¨åŠ è½½æ‚£è€…æ•°æ®...</div>
                </div>
                
                <!-- æ–‡ä»¶é€‰æ‹© -->
                <div id="file-selection" style="display: none;">
                    <h6 class="border-top pt-3">é€‰æ‹©æ•°æ®æº</h6>
                    <div id="file-list"></div>
                </div>
                
                <!-- æ²»ç–—å‚æ•°è®¾ç½® -->
                <div id="therapy-params" class="border-top pt-3" style="display: none;">
                    <h6>æ²»ç–—å‚æ•°</h6>
                    <div class="mb-2">
                        <label for="max-turns" class="form-label">æœ€å¤§å¯¹è¯è½®æ•°</label>
                        <input type="number" id="max-turns" class="form-control" value="15" min="1" max="30">
                    </div>
                </div>
                
                <!-- æ²»ç–—å¯åŠ¨æŒ‰é’® -->
                <div class="border-top pt-3">
                    <button id="start-human-therapy" class="btn btn-primary w-100 mb-2" disabled>
                        <i class="fas fa-user-md"></i> å¼€å§‹äººå·¥æ²»ç–—
                    </button>
                    <button id="start-ai-therapy" class="btn btn-success w-100" disabled>
                        <i class="fas fa-robot"></i> å¼€å§‹AIå¯¹AIæ²»ç–—
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´å¯¹è¯åŒºåŸŸ -->
        <div class="col-md-6 d-flex flex-column">
            <!-- å¯¹è¯å¤´éƒ¨ -->
            <div class="bg-white border-bottom p-3">
                <h4 class="mb-1">å¿ƒç†æ²»ç–—å¯¹è¯</h4>
                <small class="text-muted">é€‰æ‹©æ‚£è€…åå¼€å§‹æ²»ç–—ä¼šè¯</small>
                <div id="session-info" class="mt-2" style="display: none;">
                    <span class="badge bg-primary" id="session-id">ä¼šè¯ID</span>
                    <span class="badge bg-success" id="session-status">ç­‰å¾…ä¸­</span>
                </div>
            </div>
            
            <!-- èŠå¤©å®¹å™¨ -->
            <div class="chat-container flex-grow-1 d-flex flex-column">
                <!-- æ¶ˆæ¯åŒºåŸŸ -->
                <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto; min-height: 400px; max-height: calc(100vh - 200px);">
                    <div class="text-center text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>é€‰æ‹©æ‚£è€…å¼€å§‹æ²»ç–—å¯¹è¯</p>
                    </div>
                </div>
                
                <!-- äººå·¥æ²»ç–—è¾“å…¥åŒºåŸŸ -->
                <div class="human-input border-top p-3" style="display: none;">
                    <div class="input-group">
                        <input type="text" id="user-message" class="form-control" 
                               placeholder="è¾“å…¥æ‚¨çš„æ²»ç–—å»ºè®®...">
                        <button id="send-message" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i> å‘é€
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§çŠ¶æ€é¢æ¿ -->
        <div class="col-md-3 bg-light border-left d-flex flex-column" style="height: 100vh; overflow-y: auto;">
            <!-- å½“å‰çŠ¶æ€æ‘˜è¦ -->
            <div class="p-3 border-bottom">
                <h6 class="mb-3">
                    <i class="fas fa-chart-line"></i> æ²»ç–—è¿›å±•
                </h6>
                <div id="progress-summary">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">è½®æ•°</div>
                            <div class="h5 mb-0" id="current-turn">0</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">æ•ˆæœ</div>
                            <div class="h5 mb-0" id="therapy-effectiveness">0.0</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">è”ç›Ÿ</div>
                            <div class="h5 mb-0" id="therapy-alliance">0.0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å¿ƒç†çŠ¶æ€è¯¦æƒ… -->
            <div class="p-3 border-bottom">
                <h6 class="mb-3">
                    <i class="fas fa-brain"></i> å¿ƒç†çŠ¶æ€
                </h6>
                <div id="psychology-state" class="psychology-indicators">
                    <div class="text-muted small">ç­‰å¾…æ²»ç–—å¼€å§‹...</div>
                </div>
            </div>
            
            <!-- CADæ¨¡å‹çŠ¶æ€ -->
            <div class="p-3 border-bottom">
                <h6 class="mb-3">
                    <i class="fas fa-project-diagram"></i> CADæ¨¡å‹
                </h6>
                <div id="cad-state" class="cad-indicators">
                    <div class="text-muted small">ç­‰å¾…æ•°æ®æ›´æ–°...</div>
                </div>
            </div>
            
            <!-- é£é™©æŒ‡æ ‡ -->
            <div class="p-3">
                <h6 class="mb-3">
                    <i class="fas fa-exclamation-triangle"></i> é£é™©æŒ‡æ ‡
                </h6>
                <div id="risk-indicators">
                    <div class="text-muted small">æš‚æ— é£é™©è­¦å‘Š</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* æ‚£è€…å¡ç‰‡æ ·å¼ */
.patient-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.patient-card:hover {
    border-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.15);
}

.patient-card.selected {
    border-color: #007bff;
    background-color: #e7f1ff;
}

.patient-card h4 {
    font-size: 16px;
    margin-bottom: 8px;
    color: #333;
}

.patient-card .sim-id {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
}

.patient-card .status {
    font-size: 13px;
    color: #28a745;
    margin-bottom: 4px;
}

.patient-card .depression-level {
    font-size: 13px;
    color: #dc3545;
    margin-bottom: 4px;
}

/* æ–‡ä»¶é€‰æ‹©æ ·å¼ */
.file-item {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.file-item:hover {
    border-color: #28a745;
    background-color: #f8f9fa;
}

.file-item.selected {
    border-color: #28a745;
    background-color: #d4edda;
}

.file-item.recommended {
    border-color: #ffc107;
    background-color: #fff3cd;
}

.file-item h5 {
    font-size: 14px;
    margin-bottom: 4px;
    color: #333;
}

.file-item .file-desc {
    font-size: 12px;
    color: #666;
    margin-bottom: 0;
}

/* æ¶ˆæ¯æ ·å¼ */
.message {
    margin-bottom: 15px;
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 85%;
    word-wrap: break-word;
    position: relative;
}

.therapist-message {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    margin-left: auto;
    margin-right: 0;
}

.patient-message {
    background-color: #f8f9fa;
    color: #333;
    border: 1px solid #e9ecef;
    margin-left: 0;
    margin-right: auto;
}

.system-message {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
    margin: 0 auto;
    text-align: center;
    font-size: 14px;
    max-width: 70%;
}

.analysis-message {
    background: linear-gradient(135deg, #28a745, #1e7e34);
    color: white;
    margin: 0;
    max-width: 100%;
    font-size: 13px;
}

.psychology-message {
    background: linear-gradient(135deg, #17a2b8, #117a8b);
    color: white;
    margin: 0;
    max-width: 100%;
    font-size: 13px;
}

.session-header-message {
    background: linear-gradient(135deg, #6f42c1, #5a32a3);
    color: white;
    margin: 0 auto;
    text-align: center;
    max-width: 90%;
}

.message-header {
    font-weight: bold;
    font-size: 13px;
    margin-bottom: 6px;
    opacity: 0.9;
}

.message-content {
    margin-bottom: 6px;
    line-height: 1.5;
    white-space: pre-wrap;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    text-align: right;
    margin-top: 5px;
}

/* å¿ƒç†çŠ¶æ€æŒ‡æ ‡æ ·å¼ */
.psychology-indicators .indicator-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #eee;
}

.psychology-indicators .indicator-item:last-child {
    border-bottom: none;
}

.indicator-label {
    font-size: 13px;
    color: #555;
}

.indicator-value {
    font-size: 12px;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 12px;
}

.indicator-value.success {
    background-color: #d4edda;
    color: #155724;
}

.indicator-value.warning {
    background-color: #fff3cd;
    color: #856404;
}

.indicator-value.danger {
    background-color: #f8d7da;
    color: #721c24;
}

.indicator-value.dark {
    background-color: #d6d8db;
    color: #383d41;
}

/* CADæŒ‡æ ‡æ ·å¼ */
.cad-indicators {
    font-size: 12px;
}

.cad-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    border-bottom: 1px solid #eee;
}

.cad-item:last-child {
    border-bottom: none;
}

.cad-label {
    color: #555;
    flex: 1;
}

.cad-value {
    text-align: right;
    font-weight: bold;
    min-width: 60px;
}

/* é£é™©æŒ‡æ ‡æ ·å¼ */
.risk-item {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 6px;
    font-size: 12px;
    color: #856404;
}

.risk-item.high {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

/* çŠ¶æ€æ›´æ–°åŠ¨ç”» */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.updating {
    animation: pulse 1s ease-in-out;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .col-md-3, .col-md-6 {
        min-height: auto;
    }
    
    .message {
        max-width: 95%;
        font-size: 14px;
    }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
// å…¨å±€å˜é‡
let selectedPatient = null;
let selectedFile = null;
let isTherapyActive = false;
let currentSessionId = null;

// Socket.IOè¿æ¥
const socket = io();

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('refresh-patients').addEventListener('click', loadPatients);
    document.getElementById('start-ai-therapy').addEventListener('click', startAITherapy);
    document.getElementById('start-human-therapy').addEventListener('click', startHumanTherapy);
    document.getElementById('send-message').addEventListener('click', sendMessage);
    
    // å›è½¦å‘é€æ¶ˆæ¯
    document.getElementById('user-message').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Socket.IOäº‹ä»¶ç›‘å¬
    socket.on('therapy_status', handleTherapyStatus);
    socket.on('therapy_message', handleTherapyMessage);
});

// å¤„ç†æ²»ç–—çŠ¶æ€æ›´æ–°
function handleTherapyStatus(data) {
    updateSessionStatus(data.status, data.message);
    
    if (data.status === 'completed') {
        isTherapyActive = false;
        showMessage('system', 'ğŸ‰ AIå¯¹AIæ²»ç–—ä¼šè¯å®Œæˆï¼');
        
        if (data.summary) {
            const summaryText = `
ğŸ“Š æ²»ç–—æ€»ç»“ï¼š
â€¢ æ€»è½®æ•°: ${data.summary.total_turns || 0}
â€¢ å¹³å‡æ•ˆæœ: ${(data.summary.average_effectiveness || 0).toFixed(1)}/10
â€¢ æ‚£è€…: ${data.summary.patient_name || 'æœªçŸ¥'}
            `.trim();
            showMessage('analysis', summaryText);
        }
    } else if (data.status === 'error') {
        isTherapyActive = false;
        showMessage('system', `âŒ ${data.message}`);
    }
}

// å¤„ç†æ²»ç–—æ¶ˆæ¯
function handleTherapyMessage(data) {
    const { type, content, timestamp, metadata } = data;
    
    switch (type) {
        case 'system':
            showMessage('system', content, timestamp);
            break;
            
        case 'therapist':
            showMessage('therapist', content, timestamp);
            if (metadata && metadata.turn) {
                updateCurrentTurn(metadata.turn);
            }
            break;
            
        case 'patient':
            showMessage('patient', content, timestamp);
            break;
            
        case 'therapy_analysis':
            showMessage('analysis', content, timestamp);
            if (metadata && metadata.analysis_data) {
                updateTherapyMetrics(metadata.analysis_data);
            }
            break;
            
        case 'psychology_state':
            showMessage('psychology', content, timestamp);
            if (metadata && metadata.state_data) {
                updatePsychologyState(metadata.state_data);
            }
            break;
            
        case 'therapy_progress':
            showMessage('analysis', content, timestamp);
            if (metadata) {
                updateProgressMetrics(metadata);
            }
            break;
            
        case 'session_header':
            showMessage('session_header', content, timestamp);
            if (metadata) {
                updateSessionInfo(metadata);
            }
            break;
    }
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(type, content, timestamp = null) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    
    const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    
    // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
    const typeClass = type === 'therapist' ? 'therapist-message' :
                     type === 'patient' ? 'patient-message' :
                     type === 'analysis' ? 'analysis-message' :
                     type === 'psychology' ? 'psychology-message' :
                     type === 'session_header' ? 'session-header-message' :
                     'system-message';
    
    // è®¾ç½®å›¾æ ‡
    const typeIcon = type === 'therapist' ? 'ğŸ¤– AIæ²»ç–—å¸ˆ' :
                    type === 'patient' ? 'ğŸ‘¤ æ‚£è€…' :
                    type === 'analysis' ? 'ğŸ“Š åˆ†æ' :
                    type === 'psychology' ? 'ğŸ§  å¿ƒç†çŠ¶æ€' :
                    type === 'session_header' ? 'ğŸ­ ä¼šè¯ä¿¡æ¯' :
                    'ğŸ¤– ç³»ç»Ÿ';
    
    messageDiv.className = `message ${typeClass}`;
    messageDiv.innerHTML = `
        <div class="message-header">${typeIcon}</div>
        <div class="message-content">${content}</div>
        <div class="message-time">${time}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// æ›´æ–°ä¼šè¯çŠ¶æ€
function updateSessionStatus(status, message) {
    const statusBadge = document.getElementById('session-status');
    if (statusBadge) {
        statusBadge.textContent = status === 'starting' ? 'å¯åŠ¨ä¸­' :
                                 status === 'running' ? 'è¿›è¡Œä¸­' :
                                 status === 'completed' ? 'å·²å®Œæˆ' :
                                 status === 'error' ? 'é”™è¯¯' : 'ç­‰å¾…ä¸­';
        
        statusBadge.className = `badge ${
            status === 'starting' ? 'bg-warning' :
            status === 'running' ? 'bg-primary' :
            status === 'completed' ? 'bg-success' :
            status === 'error' ? 'bg-danger' : 'bg-secondary'
        }`;
    }
}

// æ›´æ–°å½“å‰è½®æ•°
function updateCurrentTurn(turn) {
    document.getElementById('current-turn').textContent = turn;
}

// æ›´æ–°æ²»ç–—æŒ‡æ ‡
function updateTherapyMetrics(analysisData) {
    const effectiveness = analysisData.overall_effectiveness || 0;
    document.getElementById('therapy-effectiveness').textContent = effectiveness.toFixed(1);
}

// æ›´æ–°è¿›å±•æŒ‡æ ‡
function updateProgressMetrics(metadata) {
    if (metadata.effectiveness !== undefined) {
        document.getElementById('therapy-effectiveness').textContent = metadata.effectiveness.toFixed(1);
    }
    if (metadata.alliance !== undefined) {
        document.getElementById('therapy-alliance').textContent = metadata.alliance.toFixed(1);
    }
}

// æ›´æ–°å¿ƒç†çŠ¶æ€æ˜¾ç¤º
function updatePsychologyState(stateData) {
    const container = document.getElementById('psychology-state');
    container.classList.add('updating');
    
    let html = '';
    
    // åŸºæœ¬ä¿¡æ¯
    if (stateData.basic_info) {
        const basic = stateData.basic_info;
        html += `<div class="indicator-item">
            <span class="indicator-label">æŠ‘éƒç¨‹åº¦</span>
            <span class="indicator-value ${getDepressionColor(basic.depression_level)}">${basic.depression_level}</span>
        </div>`;
        
        if (basic.stress_level) {
            html += `<div class="indicator-item">
                <span class="indicator-label">å‹åŠ›æ°´å¹³</span>
                <span class="indicator-value ${basic.stress_level.color}">${basic.stress_level.level}</span>
            </div>`;
        }
    }
    
    container.innerHTML = html || '<div class="text-muted small">æš‚æ— æ•°æ®</div>';
    
    // æ›´æ–°CADçŠ¶æ€
    updateCADState(stateData.cad_state);
    
    // æ›´æ–°é£é™©æŒ‡æ ‡
    updateRiskIndicators(stateData.risk_factors);
    
    setTimeout(() => container.classList.remove('updating'), 1000);
}

// æ›´æ–°CADçŠ¶æ€
function updateCADState(cadData) {
    const container = document.getElementById('cad-state');
    
    if (!cadData) {
        container.innerHTML = '<div class="text-muted small">æš‚æ— CADæ•°æ®</div>';
        return;
    }
    
    let html = '';
    const cadLabels = {
        'self_belief': 'è‡ªæˆ‘ä¿¡å¿µ',
        'world_belief': 'ä¸–ç•Œä¿¡å¿µ',
        'future_belief': 'æœªæ¥ä¿¡å¿µ',
        'rumination': 'ååˆæ€ç»´',
        'distortions': 'è®¤çŸ¥æ‰­æ›²',
        'social_withdrawal': 'ç¤¾äº¤é€€ç¼©',
        'avolition': 'åŠ¨æœºç¼ºå¤±',
        'affective_tone': 'æƒ…æ„ŸåŸºè°ƒ'
    };
    
    for (const [key, label] of Object.entries(cadLabels)) {
        if (cadData[key]) {
            const indicator = cadData[key];
            html += `<div class="cad-item">
                <span class="cad-label">${label}</span>
                <span class="cad-value indicator-value ${indicator.color}">
                    ${indicator.level} (${indicator.value.toFixed(2)})
                </span>
            </div>`;
        }
    }
    
    container.innerHTML = html || '<div class="text-muted small">æš‚æ— æ•°æ®</div>';
}

// æ›´æ–°é£é™©æŒ‡æ ‡
function updateRiskIndicators(riskFactors) {
    const container = document.getElementById('risk-indicators');
    
    if (!riskFactors || riskFactors.length === 0) {
        container.innerHTML = '<div class="text-muted small">æš‚æ— é£é™©è­¦å‘Š</div>';
        return;
    }
    
    let html = '';
    riskFactors.forEach(risk => {
        const isHigh = risk.includes('é‡åº¦') || risk.includes('ä¸¥é‡');
        html += `<div class="risk-item ${isHigh ? 'high' : ''}">âš ï¸ ${risk}</div>`;
    });
    
    container.innerHTML = html;
}

// è·å–æŠ‘éƒç¨‹åº¦é¢œè‰²ï¼ˆæ”¯æŒ10çº§ç²¾ç»†åˆ†çº§ï¼‰
function getDepressionColor(level) {
    // æ•°å­—çº§åˆ«æ˜ å°„
    if (typeof level === 'number') {
        if (level === 0) return 'success';      // æœ€ä½³çŠ¶æ€
        if (level === 1) return 'success';      // å¥åº·æ­£å¸¸
        if (level === 2) return 'info';         // æœ€å°ç—‡çŠ¶
        if (level === 3) return 'primary';      // è½»åº¦é£é™©
        if (level === 4) return 'warning';      // è½»åº¦æŠ‘éƒ
        if (level === 5) return 'warning';      // ä¸­è½»åº¦æŠ‘éƒ
        if (level === 6) return 'warning';      // ä¸­åº¦æŠ‘éƒ
        if (level === 7) return 'danger';       // ä¸­é‡åº¦æŠ‘éƒ
        if (level === 8) return 'danger';       // é‡åº¦æŠ‘éƒ
        if (level === 9) return 'dark';         // æé‡åº¦æŠ‘éƒ
    }
    
    // å­—ç¬¦ä¸²çº§åˆ«æ˜ å°„
    if (typeof level === 'string') {
        // æ–°çš„10çº§ç³»ç»Ÿ
        if (level === 'OPTIMAL' || level.includes('æœ€ä½³')) return 'success';
        if (level === 'HEALTHY' || level.includes('å¥åº·æ­£å¸¸')) return 'success';
        if (level === 'MINIMAL_SYMPTOMS' || level.includes('æœ€å°ç—‡çŠ¶')) return 'info';
        if (level === 'MILD_RISK' || level.includes('è½»åº¦é£é™©')) return 'primary';
        if (level === 'MILD' || level.includes('è½»åº¦æŠ‘éƒ')) return 'warning';
        if (level === 'MODERATE_MILD' || level.includes('ä¸­è½»åº¦')) return 'warning';
        if (level === 'MODERATE' || level.includes('ä¸­åº¦æŠ‘éƒ')) return 'warning';
        if (level === 'MODERATE_SEVERE' || level.includes('ä¸­é‡åº¦')) return 'danger';
        if (level === 'SEVERE' || level.includes('é‡åº¦æŠ‘éƒ')) return 'danger';
        if (level === 'CRITICAL' || level.includes('æé‡åº¦')) return 'dark';
        
        // å…¼å®¹æ—§ç³»ç»Ÿ
        if (level.includes('å¥åº·')) return 'success';
        if (level.includes('è½»åº¦')) return 'warning';
        if (level.includes('ä¸­åº¦')) return 'warning';
        if (level.includes('é‡åº¦')) return 'danger';
        if (level.includes('ä¸¥é‡')) return 'dark';
    }
    
    return 'secondary';
}

// åŠ è½½æ‚£è€…æ•°æ®
function loadPatients() {
    fetch('/api/patient_files')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPatients(data.simulations);
            } else {
                showError('åŠ è½½æ‚£è€…æ•°æ®å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('ç½‘ç»œé”™è¯¯: ' + error.message);
        });
}

// æ˜¾ç¤ºæ‚£è€…åˆ—è¡¨
function displayPatients(simulations) {
    const patientList = document.getElementById('patient-list');
    
    if (simulations.length === 0) {
        patientList.innerHTML = '<div class="text-center text-muted">æš‚æ— æ‚£è€…æ•°æ®</div>';
        return;
    }
    
    let html = '';
    simulations.forEach((sim, index) => {
        html += `
            <div class="patient-card" onclick="selectPatient('${sim.sim_id}', ${index})">
                <h4>${sim.patient_name}</h4>
                <p class="sim-id">${sim.sim_id}</p>
                <p class="status">${sim.status}</p>
                <p class="depression-level">æŠ‘éƒç¨‹åº¦: ${sim.depression_level}</p>
                ${sim.therapy_sessions > 0 ? `<p class="therapy-count">å·²æœ‰${sim.therapy_sessions}æ¬¡æ²»ç–—è®°å½•</p>` : ''}
            </div>
        `;
    });
    
    patientList.innerHTML = html;
    window.simulationsData = simulations;
}

// é€‰æ‹©æ‚£è€…
function selectPatient(simId, index) {
    if (isTherapyActive) {
        showError('æ²»ç–—è¿›è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢æ‚£è€…');
        return;
    }
    
    selectedPatient = {
        sim_id: simId,
        data: window.simulationsData[index]
    };
    
    // æ›´æ–°UI
    document.querySelectorAll('.patient-card').forEach(card => card.classList.remove('selected'));
    event.target.closest('.patient-card').classList.add('selected');
    
    // æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©
    displayFileSelection(selectedPatient.data.files);
    
    // æ¸…ç©ºèŠå¤©è®°å½•
    clearChat();
}

// æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©
function displayFileSelection(files) {
    const fileSelection = document.getElementById('file-selection');
    const fileList = document.getElementById('file-list');
    const therapyParams = document.getElementById('therapy-params');
    
    if (files.length === 0) {
        fileList.innerHTML = '<div class="text-center text-muted">è¯¥æ‚£è€…æš‚æ— å¯ç”¨æ•°æ®æ–‡ä»¶</div>';
        fileSelection.style.display = 'block';
        return;
    }
    
    let html = '';
    files.forEach((file, index) => {
        const isRecommended = file.type === 'complete';
        html += `
            <div class="file-item ${isRecommended ? 'recommended' : ''}" onclick="selectFile('${file.path}', '${file.name}', '${file.type}')">
                <h5>${file.name} ${isRecommended ? 'â­ æ¨è' : ''}</h5>
                <p class="file-desc">${file.description}</p>
            </div>
        `;
    });
    
    fileList.innerHTML = html;
    fileSelection.style.display = 'block';
    therapyParams.style.display = 'block';
}

// é€‰æ‹©æ–‡ä»¶
function selectFile(filePath, fileName, fileType) {
    if (isTherapyActive) {
        showError('æ²»ç–—è¿›è¡Œä¸­ï¼Œæ— æ³•åˆ‡æ¢æ–‡ä»¶');
        return;
    }
    
    selectedFile = {
        path: filePath,
        name: fileName,
        type: fileType
    };
    
    // æ›´æ–°UI
    document.querySelectorAll('.file-item').forEach(item => item.classList.remove('selected'));
    event.target.closest('.file-item').classList.add('selected');
    
    // å¯ç”¨æ²»ç–—æŒ‰é’®
    document.getElementById('start-ai-therapy').disabled = false;
    document.getElementById('start-human-therapy').disabled = false;
}

// å¯åŠ¨AIå¯¹AIæ²»ç–—
function startAITherapy() {
    if (!selectedPatient || !selectedFile) {
        showError('è¯·å…ˆé€‰æ‹©æ‚£è€…å’Œæ•°æ®æ–‡ä»¶');
        return;
    }
    
    if (isTherapyActive) {
        showError('æ²»ç–—ä¼šè¯æ­£åœ¨è¿›è¡Œä¸­');
        return;
    }
    
    const aiProvider = document.getElementById('ai-provider-select').value;
    const maxTurns = parseInt(document.getElementById('max-turns').value) || 15;
    
    isTherapyActive = true;
    currentSessionId = `therapy_${Date.now()}`;
    
    // æ›´æ–°UI
    document.getElementById('start-ai-therapy').disabled = true;
    document.getElementById('start-human-therapy').disabled = true;
    document.getElementById('session-info').style.display = 'block';
    document.getElementById('session-id').textContent = `ä¼šè¯ ${currentSessionId}`;
    
    // æ¸…ç©ºèŠå¤©è®°å½•
    clearChat();
    
    showMessage('system', 'ğŸš€ æ­£åœ¨å¯åŠ¨AIå¯¹AIæ²»ç–—ä¼šè¯...');
    
    fetch('/api/start_ai_therapy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            patient_file: selectedFile.path,
            max_turns: maxTurns,
            ai_provider: aiProvider
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('system', 'âœ… AIå¯¹AIæ²»ç–—ä¼šè¯å·²å¯åŠ¨');
            updateSessionStatus('running', 'æ²»ç–—è¿›è¡Œä¸­');
        } else {
            showError('å¯åŠ¨æ²»ç–—å¤±è´¥: ' + data.error);
            resetTherapyState();
        }
    })
    .catch(error => {
        showError('ç½‘ç»œé”™è¯¯: ' + error.message);
        resetTherapyState();
    });
}

// å¯åŠ¨äººå·¥æ²»ç–—
function startHumanTherapy() {
    showError('äººå·¥æ²»ç–—åŠŸèƒ½æš‚æœªå®ç°');
}

// å‘é€æ¶ˆæ¯
function sendMessage() {
    const messageInput = document.getElementById('user-message');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    showMessage('therapist', message);
    messageInput.value = '';
    
    // TODO: å®ç°äººå·¥æ²»ç–—æ¶ˆæ¯å‘é€
}

// é‡ç½®æ²»ç–—çŠ¶æ€
function resetTherapyState() {
    isTherapyActive = false;
    currentSessionId = null;
    
    document.getElementById('start-ai-therapy').disabled = !selectedFile;
    document.getElementById('start-human-therapy').disabled = !selectedFile;
    updateSessionStatus('waiting', 'ç­‰å¾…ä¸­');
}

// æ¸…ç©ºèŠå¤©è®°å½•
function clearChat() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = '<div class="text-center text-muted"><i class="fas fa-comments fa-3x mb-3"></i><p>ç­‰å¾…æ²»ç–—å¼€å§‹...</p></div>';
    
    // é‡ç½®çŠ¶æ€æ˜¾ç¤º
    document.getElementById('current-turn').textContent = '0';
    document.getElementById('therapy-effectiveness').textContent = '0.0';
    document.getElementById('therapy-alliance').textContent = '0.0';
    
    document.getElementById('psychology-state').innerHTML = '<div class="text-muted small">ç­‰å¾…æ²»ç–—å¼€å§‹...</div>';
    document.getElementById('cad-state').innerHTML = '<div class="text-muted small">ç­‰å¾…æ•°æ®æ›´æ–°...</div>';
    document.getElementById('risk-indicators').innerHTML = '<div class="text-muted small">æš‚æ— é£é™©è­¦å‘Š</div>';
}

// æ›´æ–°ä¼šè¯ä¿¡æ¯
function updateSessionInfo(metadata) {
    if (metadata.max_turns) {
        document.getElementById('max-turns').value = metadata.max_turns;
    }
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    showMessage('system', `âŒ ${message}`);
}
</script>

{% endblock %}